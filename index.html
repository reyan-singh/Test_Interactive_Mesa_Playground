<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisoner's Dilemma</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.4/full/pyodide.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        .header {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }
        .sidebar {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-custom {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            transition: 0.3s;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-custom:hover {
            background-color: #0056b3;
        }
        .btn-success {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .output-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
        h4 {
            font-weight: 700;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header">Prisoner's Dilemma</div>
        <div class="row">
            <div class="col-md-3 sidebar">
                <h4>Controls</h4>
                <button id="loadPyodide" class="btn btn-custom w-100 mb-2">LOAD PYODIDE</button>
                <button id="loadPandas" class="btn btn-custom w-100 mb-2" disabled>LOAD PANDAS</button>
                <button id="loadPolars" class="btn btn-custom w-100 mb-2" disabled>LOAD POLARS</button>
                <button id="loadMatplotlib" class="btn btn-custom w-100 mb-2" disabled>LOAD MATPLOTLIB</button>
                <button id="loadMesa" class="btn btn-custom w-100 mb-2" disabled>LOAD MESA</button>
                <button id="runGameModel" class="btn btn-success w-100 mb-2" disabled>RUN MODEL</button>
            </div>

            <div class="col-md-6">
                <div class="output-container">
                    <h4>Visualization</h4>
                    <div id="visualization" class="text-center" style="height: 300px; background-color: #e9ecef; border-radius: 8px;"></div>               
                </div>
            </div>              
            <div id="params" style="display:none;">
                <label>Agents: <input type="number" id="numAgents" value="100" min="10" max="1000"></label>
                <label>Cooperation: <input type="range" id="coopProb" min="0" max="1" step="0.1" value="0.5"></label>
                <button id="updateModel">Update</button>
            </div>
            <div class="output-container">
                <h4>Output</h4>
                <pre id="output"></pre>
                <pre id="error" class="text-danger"></pre>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const output = document.getElementById('output');
            const error = document.getElementById('error');
            const viz = document.getElementById('visualization');
            let pyodide = null;
        
            // Helpers
            const log = msg => output.textContent += msg + '\n';
            const logError = err => error.textContent += `ERROR: ${err.message}\n`;
        
            // 1. Load Pyodide
            document.getElementById('loadPyodide').addEventListener('click', async () => {
                try {
                    log('Loading Pyodide...');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/pyodide/v0.27.4/full/pyodide.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = () => reject(new Error('Pyodide load failed'));
                    });
        
                    pyodide = await loadPyodide();
                    log('Pyodide loaded!');
                    document.getElementById('loadPandas').disabled = false;
                } catch(err) {
                    logError(err);
                }
            });
        
            // 2. Load Pandas
            document.getElementById('loadPandas').addEventListener('click', async () => {
                try {
                    log('Loading Pandas...');
                    await pyodide.loadPackage('pandas');
                    log('Pandas loaded!');
                    document.getElementById('loadPolars').disabled = false;
                } catch(err) {
                    logError(err);
                }
            });
        
            // 3. Load Polars
            document.getElementById('loadPolars').addEventListener('click', async () => {
                try {
                    log('Loading Polars...');
                    await pyodide.loadPackage('micropip');
                    await pyodide.runPythonAsync(`
                        import micropip
                        await micropip.install('polars')
                    `);
                    log('Polars loaded!');
                    document.getElementById('loadMatplotlib').disabled = false;
                } catch(err) {
                    logError(err);
                }
            });
        
            // 4. Load Matplotlib
            document.getElementById('loadMatplotlib').addEventListener('click', async () => {
                try {
                    log('Loading Matplotlib...');
                    await pyodide.loadPackage('matplotlib');
                    await pyodide.runPythonAsync(`
                        import matplotlib
                        matplotlib.use('Agg')
                    `);
                    log('Matplotlib ready!');
                    document.getElementById('loadMesa').disabled = false;
                } catch(err) {
                    logError(err);
                }
            });
        
            // 5. Load Mesa
            document.getElementById('loadMesa').addEventListener('click', async () => {
                // try {
                    log('Loading Mesa...');
                    await pyodide.loadPackage('micropip');
                    await pyodide.runPythonAsync(`
                        import micropip
                        await micropip.install('mesa')
                    `);
                    log('Mesa loaded!');
                    document.getElementById('runGameModel').disabled = false;
                // } catch(err) {
                //     logError(err);
                // }
            });
        
            // 6. Game Theory Model (Mesa 3.0+)
            document.getElementById('runGameModel').addEventListener('click', async () => {
                try {
                    const numAgents = document.getElementById('numAgents').value;
                    const coopProb = document.getElementById('coopProb').value;
                    document.getElementById('params').style.display = 'block';
                    // document.getElementById('params').style.display = 'none'
                    viz.innerHTML = await pyodide.runPythonAsync(`
                        import mesa
                        import matplotlib.pyplot as plt
                        import numpy as np
                        import io, base64
        
                        class GameAgent(mesa.Agent):
                            def __init__(self, model):
                                super().__init__(model)
                                self.score = 0
                                self.coop_prob = ${coopProb}
                                self.last_action = None
        
                            def step(self):
                                partner = self.model.random.choice(self.model.agents)
                                if partner is self: return
                                
                                payoff = {
                                    ('C','C'): (3,3), ('C','D'): (0,5),
                                    ('D','C'): (5,0), ('D','D'): (1,1)
                                }
                                
                                my_action = 'C' if self.random.random() < self.coop_prob else 'D'
                                their_action = partner.last_action or 'C'
                                
                                self.score += payoff[(my_action, their_action)][0]
                                partner.score += payoff[(my_action, their_action)][1]
                                self.last_action = my_action
        
                        class GameModel(mesa.Model):
                            def __init__(self, N):
                                super().__init__()
                                self.num_agents = N
                                self.datacollector = mesa.DataCollector(
                                    agent_reporters={"Score": "score"}
                                )
                                for _ in range(N):
                                    self.agents.add(GameAgent(self))
        
                            def step(self):
                                self.agents.shuffle_do("step")
                                self.datacollector.collect(self)
                                self.steps += 1
        
                        model = GameModel(${numAgents})
                        for _ in range(50):
                            model.step()
        
                        # Visualization
                        df = model.datacollector.get_agent_vars_dataframe()
                        plt.figure(figsize=(10,4))
                        
                        plt.subplot(121)
                        df['Score'].hist(bins=20)
                        plt.title('Score Distribution')
                        
                        plt.subplot(122)
                        df.groupby('Step')['Score'].mean().plot()
                        plt.title('Average Score Trend')
                        
                        buf = io.BytesIO()
                        plt.savefig(buf, format='png', bbox_inches='tight')
                        buf.seek(0)
                        img_str = base64.b64encode(buf.read()).decode()
                        plt.close()
                        
                        f'<img src="data:image/png;base64,{img_str}" class="plot">'
                    `);
                    log('Model executed!');
                } catch(err) {
                    logError(err);
                }
            });
        
            // Update handler
            document.getElementById('updateModel').addEventListener('click', () => {
                document.getElementById('runGameModel').click();
            });
        });
        </script>
</body>
</html>
